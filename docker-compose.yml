services:
  backend:
    build:
      context: ./backend
    ports:
      - '8001:3000'
    environment:
      - DATABASE_HOST=db
      - DATABASE_USER=user
      - DATABASE_PASSWORD=password
      - DATABASE_NAME=testdb
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - /app/node_modules
    command: npm run start:dev

  frontend:
    build:
      context: ./frontend
    ports:
      - '8081:3000'
    environment:
      - API_URL=http://backend:3000
    depends_on:
      - backend
    volumes:
      - ./frontend:/app
      - /app/node_modules
    command: npm run dev -- --host 0.0.0.0

  db:
    image: mysql:8.0
    restart: "no"
    environment:
      MYSQL_DATABASE: testdb
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_ROOT_PASSWORD: rootpassword
    ports:
      - '3308:3306'
    volumes:
      - mysql_data:/var/lib/mysql
      - mysql_run:/var/run/mysqld
    command: >
      --authentication-policy=caching_sha2_password
      --host-cache-size=0
      --pid-file=/var/lib/mysql/mysqld.pid
      --socket=/var/run/mysqld/mysqld.sock
      --skip-ssl
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  mysql_data:
  mysql_run:
